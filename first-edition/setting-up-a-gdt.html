<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Setting up a GDT - intermezzOS</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="preface.html">Preface</a></li><li><a href="background.html"><strong aria-hidden="true">1.</strong> Background</a></li><li><ol class="section"><li><a href="what.html"><strong aria-hidden="true">1.1.</strong> What is an OS?</a></li><li><a href="what-kind-is-there.html"><strong aria-hidden="true">1.2.</strong> What kinds of OS are there?</a></li><li><a href="what-kind-are-we-making.html"><strong aria-hidden="true">1.3.</strong> What kind are we making?</a></li><li><a href="tools.html"><strong aria-hidden="true">1.4.</strong> What tools will we use?</a></li></ol></li><li><a href="setup.html"><strong aria-hidden="true">2.</strong> Setting up a development environment</a></li><li><ol class="section"><li><a href="installing-rust.html"><strong aria-hidden="true">2.1.</strong> Installing Rust</a></li><li><a href="linux.html"><strong aria-hidden="true">2.2.</strong> Linux</a></li><li><a href="osx.html"><strong aria-hidden="true">2.3.</strong> Mac OS X</a></li><li><a href="windows.html"><strong aria-hidden="true">2.4.</strong> Windows</a></li></ol></li><li><a href="booting-up.html"><strong aria-hidden="true">3.</strong> Booting up</a></li><li><ol class="section"><li><a href="multiboot-headers.html"><strong aria-hidden="true">3.1.</strong> Multiboot headers</a></li><li><a href="hello-world.html"><strong aria-hidden="true">3.2.</strong> Hello, world!</a></li><li><a href="making-an-iso.html"><strong aria-hidden="true">3.3.</strong> Making an ISO</a></li><li><a href="running-in-qemu.html"><strong aria-hidden="true">3.4.</strong> Running in QEMU</a></li><li><a href="automation-with-make.html"><strong aria-hidden="true">3.5.</strong> Automation with Make</a></li></ol></li><li><a href="transitioning-to-long-mode.html"><strong aria-hidden="true">4.</strong> Transitioning to Long Mode</a></li><li><ol class="section"><li><a href="paging.html"><strong aria-hidden="true">4.1.</strong> Paging</a></li><li><a href="setting-up-a-gdt.html" class="active"><strong aria-hidden="true">4.2.</strong> Setting up a GDT</a></li><li><a href="jumping-headlong-into-long-mode.html"><strong aria-hidden="true">4.3.</strong> Jumping headlong into long mode</a></li></ol></li><li><a href="a-rust-kmain.html"><strong aria-hidden="true">5.</strong> A Rust kmain()</a></li><li><ol class="section"><li><a href="creating-our-first-crate.html"><strong aria-hidden="true">5.1.</strong> Creating our first crate</a></li><li><a href="hello-from-rust.html"><strong aria-hidden="true">5.2.</strong> Hello from Rust!</a></li><li class="spacer"></li></ol></li><li><a href="appendix/troubleshooting.html">Appendix A: Troubleshooting</a></li><li class="affix"><a href="appendix/numeral-systems.html">Appendix B: Numeral Systems</a></li><li class="affix"><a href="appendix/osx-install.html">Appendix C: Mac OS X Install Script</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">intermezzOS</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#setting-up-a-gdt" id="setting-up-a-gdt">Setting up a GDT</a></h1>
<p>We’re so close! We’re currently in long mode, but not ‘real’ long mode. We need
to go from this ‘compatibility mode’ to honest-to-goodness long mode. To do
this, we need to set up a ‘global descriptor table’.</p>
<p>This table, also known as a GDT, is kind of vestigial. The GDT is used for a
style of memory handling called ‘segmentation’, which is in contrast to the
paging model that we just set up. Even though we’re not using segmentation,
however, we’re still required to have a valid GDT. Such is life.</p>
<p>So let’s set up a minimal GDT. Our GDT will have three entries:</p>
<ul>
<li>a ‘zero entry’</li>
<li>a ‘code segment’</li>
<li>a ‘data segment’</li>
</ul>
<p>If we were going to be using the GDT for real stuff, it could have a number
of code and data segment entries. But we need at least one of each to have a
minimum viable table, so let’s get to it!</p>
<h2><a class="header" href="#the-zero-entry" id="the-zero-entry">The Zero entry</a></h2>
<p>The first entry in the GDT is special: it needs to be a zero value. Add this
to the bottom of <code>boot.asm</code>:</p>
<pre><code class="language-x86asm">section .rodata
gdt64:
    dq 0
</code></pre>
<p>We have a new section: <code>rodata</code>. This stands for ‘read only data’, and since
we’re not going to modify our GDT, having it be read-only is a good idea.</p>
<p>Next, we have a label: <code>gdt64</code>. We’ll use this label later, to tell the hardware
where our GDT is located.</p>
<p>Finally, <code>dq 0</code>. This is ‘define quad-word’, in other words, a 64-bit value.
Given that it’s a zero entry, it shouldn’t be too surprising that the value of
this entry is zero!</p>
<p>That’s all there is to it.</p>
<h2><a class="header" href="#setting-up-a-code-segment" id="setting-up-a-code-segment">Setting up a code segment</a></h2>
<p>Next, we need a code segment. Add this below the <code>dq 0</code>:</p>
<pre><code class="language-x86asm">.code: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41) | (1&lt;&lt;43) | (1&lt;&lt;53)
</code></pre>
<p>Let's talk about the <code>dq</code> line first. If you recall from the last section,
<code>1&lt;&lt;44</code> means ‘left shift one 44 places’, which sets the 44th bit. But what
about <code>|</code>? This means <code>or</code>. So, if we <code>or</code> a bunch of these values together,
we’ll end up with a value that has the 44th, 47th, 41st, 43rd, and 53rd bit
set.</p>
<p>Why <code>|</code> and not <code>or</code>, like before? Well, here, we’re not running assembly
instructions: we’re defining some data. So there’s no instruction to execute, so
the language used is a bit different.</p>
<p>Finally, why these bits? Well, as we’ve seen with other table entries, each bit
has a meaning. Here’s a summary:</p>
<ul>
<li>44: ‘descriptor type’: This has to be <code>1</code> for code and data segments</li>
<li>47: ‘present’: This is set to <code>1</code> if the entry is valid</li>
<li>41: ‘read/write’: If this is a code segment, <code>1</code> means that it’s readable</li>
<li>43: ‘executable’: Set to <code>1</code> for code segments</li>
<li>53: ‘64-bit’: if this is a 64-bit GDT, this should be set</li>
</ul>
<p>That’s all we need for a valid code segment!</p>
<p>Oh, but let's not forget about the other line:</p>
<pre><code class="language-x86asm">.code: equ $ - gdt64
</code></pre>
<p>What's up with this? So, in a bit, we'll need to reference this entry somehow.
But we don't reference the entry by its address, we reference it by an offset.
If we needed just an address, we could use <code>code:</code>. But we can't, so we need
more. Also, note that period at the start, it's <code>.code:</code>. This tells the
assembler to scope this label under the last label that appeared, so we'll
say <code>gdt64.code</code> rather than just <code>code</code>. Some nice encapsulation.</p>
<p>So that's what's up with the label, but we still have this <code>equ $ - gdt64</code> bit.
<code>$</code> is the current position. So we're subtracting the address of <code>gdt64</code> from
the current position. Conveniently, that's the offset number we need for later:
how far is this segment past the start of the GDT. The <code>equ</code> sets the address
for the label; in other words, this line is saying &quot;set the <code>.code</code> label's
value to the current address minus the address of <code>gdt64</code>&quot;. Got it?</p>
<h2><a class="header" href="#setting-up-a-data-segment" id="setting-up-a-data-segment">Setting up a data segment</a></h2>
<p>Below the code segment, add this for a data segment:</p>
<pre><code class="language-x86asm">.data: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41)
</code></pre>
<p>We need less bits set for a data segment. But they’re ones we covered before.
The only difference is bit 41; for data segments, a <code>1</code> means that it’s
writable.</p>
<p>We also use the same trick again with the labels, calculating the offset with
<code>equ</code>.</p>
<h2><a class="header" href="#putting-it-all-together" id="putting-it-all-together">Putting it all together</a></h2>
<p>Here’s our whole GDT:</p>
<pre><code class="language-x86asm">section .rodata
gdt64:
    dq 0
.code: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41) | (1&lt;&lt;43) | (1&lt;&lt;53)
.data: equ $ - gdt64
    dq (1&lt;&lt;44) | (1&lt;&lt;47) | (1&lt;&lt;41)
</code></pre>
<p>We’re so close! Now, to tell the hardware about our GDT. There’s a special
assembly instruction for this: <code>lgdt</code>. But it doesn’t take the GDT itself; it
takes a special structure: two bytes for the length, and eight bytes for the
address. So we have to set <em>that</em> up.</p>
<p>Below these <code>dq</code>s, add this:</p>
<pre><code class="language-x86asm">.pointer:
    dw .pointer - gdt64 - 1
    dq gdt64
</code></pre>
<p>To calculate the length, we take the value of this new label, <code>pointer</code>, and
subtract the value of <code>gdt64</code>, and then subtract one more. We could calculate
this length manually, but if we do it this way, if we add another GDT entry for
some reason, it will automatically correct itself, which is nice.</p>
<p>The <code>dq</code> here has the address of our table. Straightforward.</p>
<h2><a class="header" href="#load-the-gdt" id="load-the-gdt">Load the GDT</a></h2>
<p>So! We’re finally ready to tell the hardware about our GDT. Add this line after
all of the paging stuff we did in the last chapter:</p>
<pre><code class="language-x86asm">    lgdt [gdt64.pointer]
</code></pre>
<p>We pass <code>lgdt</code> the value of our <code>pointer</code> label. <code>lgdt</code> stands for ‘load global
descriptor table’. That’s it!</p>
<p>We have all of the prerequisites done! In the next section, we will complete our
transition by jumping to long mode.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="paging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="jumping-headlong-into-long-mode.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="paging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="jumping-headlong-into-long-mode.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
