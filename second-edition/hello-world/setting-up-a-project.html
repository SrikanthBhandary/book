<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Setting up a project - The intermezzOS Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="src/theme/extra.css">
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">var path_to_root = "../";</script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="../preface.html">Preface</a></li><li><a href="../background/index.html"><strong aria-hidden="true">1.</strong> Background</a></li><li><ol class="section"><li><a href="../background/what.html"><strong aria-hidden="true">1.1.</strong> What is an OS?</a></li><li><a href="../background/what-kind-is-there.html"><strong aria-hidden="true">1.2.</strong> What kinds of OS are there?</a></li><li><a href="../background/what-kind-are-we-making.html"><strong aria-hidden="true">1.3.</strong> What kind are we making?</a></li><li><a href="../background/tools.html"><strong aria-hidden="true">1.4.</strong> What tools will we use?</a></li></ol></li><li><a href="../hello-world/index.html"><strong aria-hidden="true">2.</strong> From Zero to &quot;Hello, world!&quot;</a></li><li><ol class="section"><li><a href="../hello-world/setup.html"><strong aria-hidden="true">2.1.</strong> Setting up a development environment</a></li><li><a href="../hello-world/setting-up-a-project.html" class="active"><strong aria-hidden="true">2.2.</strong> Setting up a project</a></li><li><a href="../hello-world/from-zero-to-start-in-detail.html"><strong aria-hidden="true">2.3.</strong> From zero to _start in detail</a></li></ol></li><li><a href="../fractal-learning.html"><strong aria-hidden="true">3.</strong> Interlude: fractal learning</a></li><li><a href="../vga/index.html"><strong aria-hidden="true">4.</strong> Printing to the screen: a text mode VGA driver</a></li><li><ol class="section"><li><a href="../vga/hello-world.html"><strong aria-hidden="true">4.1.</strong> A VGA &quot;hello world&quot;</a></li><li><a href="../vga/understanding-text-mode.html"><strong aria-hidden="true">4.2.</strong> Understanding text mode</a></li><li><a href="../vga/nicer-implementation.html"><strong aria-hidden="true">4.3.</strong> A nicer implementation</a></li><li class="spacer"></li></ol></li><li><a href="../appendix/target-specifications.html">Appendix A: target specifications</a></li><li class="affix"><a href="../appendix/hexadecimal-numbers.html">Appendix B: hexadecimal numbers</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The intermezzOS Book</h1> 

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#setting-up-a-project" id="setting-up-a-project"><h1>Setting up a project</h1></a>
<p>Now that we are all set up, let's get going! First, let's go to our project
directory:</p>
<pre><code class="language-bash">$ cd ~/src
</code></pre>
<p>And then, we'll use <code>cargo new</code> to create a new binary project:</p>
<pre><code class="language-bash">$ cargo new --bin intermezzos
     Created binary (application) `intermezzos` project
</code></pre>
<blockquote>
<p>Feel free to name your kernel something else!</p>
</blockquote>
<p>This will create a new directory, <code>intermezzos</code>, inside our project
directory. Let's move into it:</p>
<pre><code class="language-bash">$ cd intermezzos
</code></pre>
<p>Cargo has created three things for us: a <code>src/main.rs</code> file, that contains
our Rust source code. A <code>Cargo.toml</code>, which contains metadata about our
project. And finally, a <code>.gitignore</code>, if you use <code>git</code>.</p>
<blockquote>
<p>Sidebar: Rust knowledge</p>
<p>We don't inherently assume that you know Rust well, but this book also
isn't a Rust tutorial. We'll try to explain the basics of the code we're
writing, but you may want to check out <a href="https://doc.rust-lang.org/book/second-edition/">The Rust Programming
Language</a> if you don't
understand our basic explanations here. If you've never used Rust before, you
might want to take a moment and skim <a href="https://doc.rust-lang.org/book/second-edition/ch03-00-common-programming-concepts.html">Chapter
3</a>,
which covers the basic syntax and talks about stuff you've seen in
programming languages you have used in the past.</p>
</blockquote>
<a class="header" href="#our-first-hello-world" id="our-first-hello-world"><h2>Our first Hello, World</h2></a>
<p>If you investigate the contents of <code>src/main.rs</code>, you'll find this:</p>
<pre><pre class="playpen"><code class="language-rust">fn main() {
    println!(&quot;Hello, world!&quot;);
}
</code></pre></pre>
<p>Cargo generated a &quot;hello world&quot; program for us! Let's try it out:</p>
<pre><code class="language-bash">$ cargo run
   Compiling intermezzos v0.1.0 (file:///~/src/intermezzos)
    Finished dev [unoptimized + debuginfo] target(s) in 2.5 secs
     Running `target/debug/intermezzos.exe`
Hello, world!
</code></pre>
<p>If you see the &quot;Hello, world!&quot; printed to your screen, then your Rust toolchain is working!</p>
<a class="header" href="#hosts-and-targets" id="hosts-and-targets"><h2>Hosts and Targets</h2></a>
<p>This program is compiled for our own computer hardware and operating system.
The computer we're compiling <em>from</em> is called the &quot;host system.&quot; But, our new
OS won't be using the OS of the computer we're doing development on! The
computer we want to compile <em>to</em> is called the &quot;target system.&quot;</p>
<p>When the host and target system are the same, most people just say
&quot;compiling.&quot; When they host and taget are different, people say that you're
&quot;cross-compiling.&quot;</p>
<p>To cross-compile, <code>cargo</code> takes an argument, <code>--target</code>. We can then tell it
what kind of computer we want to compile to, and it will do the right thing.
However, by default, Rust can't know every single kind of computer and OS
that we would want to compile to: after all, we're creating a new OS right
now!</p>
<p>To solve this, we need to write some JSON.</p>
<a class="header" href="#creating-intermezzosjson" id="creating-intermezzosjson"><h3>Creating intermezzos.json</h3></a>
<p>Rust has a feature called &quot;target specifications&quot; that lets us, well, specify
a target. To do that, we create a JSON file, and use it to describe all the
things that the compiler needs to know in order to generate the proper code.</p>
<p>Create a new file named <code>intermezzos.json</code> and put this in it:</p>
<pre><code class="language-json">{
  &quot;llvm-target&quot;: &quot;x86_64-unknown-none&quot;,
  &quot;data-layout&quot;: &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;,
  &quot;arch&quot;: &quot;x86_64&quot;,
  &quot;target-endian&quot;: &quot;little&quot;,
  &quot;target-pointer-width&quot;: &quot;64&quot;,
  &quot;target-c-int-width&quot;: &quot;32&quot;,
  &quot;os&quot;: &quot;none&quot;,
  &quot;linker&quot;: &quot;rust-lld&quot;,
  &quot;linker-flavor&quot;: &quot;ld.lld&quot;,
  &quot;executables&quot;: true,
  &quot;features&quot;: &quot;-mmx,-sse,+soft-float&quot;,
  &quot;disable-redzone&quot;: true,
  &quot;panic-strategy&quot;: &quot;abort&quot;
}
</code></pre>
<p>To learn more about this file, check out Appendix A. For now, it's mostly a
distraction; you don't <em>need</em> to know what's going on here to continue.</p>
<a class="header" href="#removing-the-standard-library" id="removing-the-standard-library"><h2>Removing the standard library</h2></a>
<p>Okay, let's write some Rust! Delete the code in <code>src/main.rs</code>, and replace it
with this:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#![feature(panic_implementation)]
#![feature(core_intrinsics)]
#![no_std]
#![no_main]

#fn main() {
extern crate bootloader_precompiled;

use core::intrinsics;
use core::panic::PanicInfo;

#[panic_implementation]
#[no_mangle]
fn panic(_info: &amp;PanicInfo) -&gt; ! {
    unsafe { intrinsics::abort() }
}

#[no_mangle]
pub fn _start() -&gt; ! {
    loop {}
}
#}</code></pre></pre>
<p>Let's go over the code, bit by bit:</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// ...

#![no_std]
#![no_main]

// ...
#}</code></pre></pre>
<p>These two attributes tell Rust, &quot;hey, we don't want a standard library, and
we don't want a <code>main</code> function.&quot; When writing an OS, we want full control
over the details. The Rust standard library assumes that an operating system
exists, and we don't have any of that yet, so we can't use it. Rust's default
<code>main</code> includes stuff that we <em>could</em> use, but it's nicer to write our own,
so we have that full control.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#![feature(panic_implementation)]
#![feature(core_intrinsics)]

#fn main() {
// ... 

extern crate bootloader_precompiled;

use core::intrinsics;
use core::panic::PanicInfo;

#[panic_implementation]
#[no_mangle]
fn panic(_info: &amp;PanicInfo) -&gt; ! {
    unsafe { intrinsics::abort() }
}
#}</code></pre></pre>
<p>When we don't include the standard library, then we're missing one important
thing: if we <code>panic!</code>, Rust wants to call a callback before aborting. This is
that callback. All we do is abort our program.</p>
<p>The <code>extern crate</code> line will set up our bootloader, that is, the code that
loads our OS after the computer starts up. We'll talk more about this later.</p>
<p>Other than that, this is boilerplate. We'll talk about this stuff more when we
actually do something on panics; for now, don't worry about it.</p>
<pre><pre class="playpen"><code class="language-rust">
# #![allow(unused_variables)]
#fn main() {
// ...

#[no_mangle]
pub fn _start() -&gt; ! {
    loop {}
}
#}</code></pre></pre>
<p>This is our <code>main</code> function, even though it's named <code>_start</code>. Have you ever
wondered how <code>main</code> gets called? Technically, <code>_start</code> gets called first,
then that calls your <code>main</code> function. Any setup code goes in <code>_start</code>, and
would run before it calls <code>main</code>.</p>
<p>Let's explain this function in a <em>bit</em> more detail. The <code>#[no_mangle]</code>
attribute says &quot;hey Rust, it's really important that this function is named
<em>exactly</em> this.&quot; You see, Rust is free to rename functions for you. There's
good reasons for this that we won't get into here. This attribute disables
that. If Rust renamed this function, then we wouldn't be able to boot up
properly. We'll explain more in the next section.</p>
<p>The <code>!</code> return type means we never return, and we never return because the
only thing we do is <code>loop</code> forever!</p>
<p>With this code, our little kernel will start, and then do nothing. It's a
start!</p>
<a class="header" href="#aborting-on-panic" id="aborting-on-panic"><h2>Aborting on panic</h2></a>
<p>While we set up a panic handler, that's not the only thing that occurs on
a panic. After our handler is called, Rust can do one of two things: abort
the entire program, or &quot;unwind the stack.&quot; Since we're an OS, if our OS
panics, we want to abort. Unwinding can be useful for some applications, but
not an OS, as if we crash, it's all over. As such, we're going to skip over
explaining what unwinding is for now, and simply set things up to abort. Go
into <code>Cargo.toml</code> and add these lines:</p>
<pre><code class="language-toml">[profile.dev]
panic = &quot;abort&quot;

[profile.release]
panic = &quot;abort&quot;
</code></pre>
<p>Cargo has a concept of &quot;release profiles&quot; that let us get a development
build or a release build. With this configuration, we're telling the
Rust compiler that we want to abort when a panic occurs.</p>
<a class="header" href="#including-a-bootloader" id="including-a-bootloader"><h2>Including a bootloader</h2></a>
<p>Earlier we had an <code>extern crate</code> line talking about <code>bootloader_precompiled</code>.
We need to add that to our <code>Cargo.toml</code>:</p>
<pre><code class="language-toml">[dependencies]
bootloader_precompiled = &quot;0.2.0&quot;
</code></pre>
<a class="header" href="#compiling-with-bootimage" id="compiling-with-bootimage"><h2>Compiling with <code>bootimage</code></h2></a>
<p>Now that we have our code, it's time to compile it! First, we want to make
sure that we are using the nightly version of Rust, so run this:</p>
<pre><code class="language-bash">$ rustup override set nightly
</code></pre>
<p>Now, any time we're in this project, <code>rustup</code> will ensure we're using nightly
Rust, automatically.</p>
<p>To build the project, we use the <em>bootimage</em> tool we installed earlier. Run
this:</p>
<pre><code class="language-bash">$ bootimage build --target=intermezzos.json
</code></pre>
<p>The target flag must have the same name as the <code>.json</code> file you've made, so
if you picked a different name, make sure to use it here!</p>
<p>You should see some output that looks like this:</p>
<pre><code class="language-bash">$ bootimage --target=intermezzos
   Compiling core v0.0.0 (file:///~/.rustup/toolchains/nightly-x86_64-pc-windows-msvc/lib/rustlib/src/rust/src/libcore)
    Finished release [optimized] target(s) in 65.72 secs
   Compiling intermezzos v0.1.0 (file:///~/src/intermezzos/intermezzos)
    Finished dev [unoptimized + debuginfo] target(s) in 0.82 secs
Downloading bootloader...
Creating disk image at bootimage.bin
</code></pre>
<p>If you remember from Chapter 2, we installed two tools: <code>bootimage</code> and
<code>cargo-xbuild</code>. In this case, what happens is:</p>
<ul>
<li><code>bootimage</code> calls <code>xargo</code> to compile <code>libcore</code>, Rust's smallest library.</li>
<li><code>cargo-xbuild</code> calls <code>cargo</code> to build our OS, passing flags to use that new
<code>libcore</code>.</li>
<li><code>cargo</code> calls <code>rustc</code> to actually compile our OS's code itself.</li>
<li><code>bootimage</code> then takes our code and makes a <code>.bin</code> file.</li>
</ul>
<p>Whew! That's a lot of stuff. We'll go over the details of what exactly these
steps mean in the next section. But at this point, if <code>bootimage.bin</code> exists,
you've successfully compiled your very first OS! It doesn't do much, but
everyone starts somewhere.</p>
<a class="header" href="#running-with-qemu" id="running-with-qemu"><h2>Running with <code>qemu</code></h2></a>
<p>Let's try running it! To load up our OS in <code>qemu</code>, type this:</p>
<pre><code class="language-bash">$ qemu-system-x86_64 -drive format=raw,file=bootimage.bin
</code></pre>
<p>You should hopefully get something that looks like this:</p>
<p><img alt="program on hardware" class="center" src="../assets/qemu.png" /></p>
<p>Hooray! Since our OS does nothing, we get a blank screen. To be clear, this
is emulating hardware, and our OS is running on it, on our own computer.
Excellent!</p>
<p>Let's step back slightly and go over what that command does:</p>
<pre><code class="language-bash">qemu-system-x86_64
</code></pre>
<p><code>qemu</code> installs virtual machines for all kinds of systems, we specifically
want an <code>x86_64</code> machine, so we need to invoke the command that will start
it.</p>
<pre><code class="language-bash">-drive
</code></pre>
<p>This parameter sets up a disk drive for our virtual machine. We need one of
those so that it knows what to actually load.</p>
<pre><code class="language-bash">format=raw,file=bootimage.bin
</code></pre>
<p>This is the value of the <code>-drive</code> parameter. It's split into two parts; the
first is that we want the format to be 'raw', that is, just use the bytes
directly, it's not formatted as a specific filesystem. The second is the file
that we want to actually load for that disk; it's our <code>bootimage.bin</code> file we
just produced with <code>bootimage</code>.</p>
<a class="header" href="#some-conveniences" id="some-conveniences"><h2>Some conveniences</h2></a>
<p><code>bootimage</code> can make this even easier! Go to your <code>Cargo.toml</code>, and add
this section:</p>
<pre><code class="language-toml">[package.metadata.bootimage]
default-target = &quot;intermezzos.json&quot;
</code></pre>
<p>If you named your JSON file something different, use that name.</p>
<p>Once we've done this, we can do:</p>
<pre><code class="language-shell">$ bootimage build
$ bootimage run
</code></pre>
<p>With this, <code>bootimage build</code> will default to <code>--target=intermezzos.json</code>, and
<code>bootimage run</code> will run the same Qemu command we've been using so far. This
is much more convenient!</p>
<p>For more info, see <a href="https://github.com/rust-osdev/bootimage#configuration">bootimage's
documentation</a>.</p>
<a class="header" href="#conclusion" id="conclusion"><h2>Conclusion</h2></a>
<p>Congrats! This is the first step on our journey building operating systems.
It only gets cooler from here. But before we move on, let's take a step back
and investigate in a bit more depth what we actually just did.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../hello-world/setup.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../hello-world/from-zero-to-start-in-detail.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../hello-world/setup.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../hello-world/from-zero-to-start-in-detail.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
